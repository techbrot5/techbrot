<!doctype html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Payment Successful | TechBrot Inc. — QuickBooks Support & Bookkeeping</title>
  <meta name="description" content="Thank you for your payment! Your QuickBooks setup or bookkeeping service has been confirmed. A Certified ProAdvisor will contact you soon.">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{ --accent:#06b6d4; --muted:#6c757d; --success:#16a34a }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f8fafb;color:#0b1220}
    main.container{max-width:1100px;padding:2rem 1rem}
    #confetti-canvas{position:fixed;inset:0;z-index:1050;pointer-events:none}
    #receipt{background:#fff;border-radius:.5rem;padding:1rem;box-shadow:0 9px 30px rgba(12,22,46,0.05)}
    .badge-svg{width:56px;height:56px;display:inline-flex;align-items:center;justify-content:center;border-radius:12px;background:linear-gradient(180deg,#e8fff9,#f0ffff);border:1px solid rgba(6,182,212,0.08)}
    .muted{color:var(--muted)!important}
    @media (max-width:767.98px){ main.container{padding:1rem} }
  </style>
</head>
<body>
  <canvas id="confetti-canvas" aria-hidden="true"></canvas>

  <main class="container">
    <div class="row g-4 align-items-start" id="successCard">
      <section class="col-12 col-lg-8">
        <div class="d-flex gap-3 mb-3 align-items-start">
          <div class="badge-svg" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#28a745" viewBox="0 0 24 24" aria-hidden="true"><path d="M20.285 6.709l-11.49 11.49-5.657-5.657 1.414-1.414 4.243 4.243 10.076-10.076z"></path></svg>
          </div>
          <div class="flex-grow-1">
            <h1 id="thankHeading" class="h4 mb-1">Payment received — thank you</h1>
            <p id="subLead" class="mb-1 text-muted">We've received your payment. A receipt was emailed to you. You can download a printer-friendly PDF below.</p>
            <div class="small muted">Need help? Email <a id="contactEmail" class="link-primary" href="mailto:support@techbrot.com">support@techbrot.com</a> · <span class="text-muted">Phone: <a href="tel:+18777515575">+1 (877) 751-5575</a></span></div>
          </div>
        </div>

        <article id="receipt" class="mb-3" aria-labelledby="receiptLabel">
          <header class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <div id="merchantName" class="fw-semibold">TechBrot Inc.</div>
              <div class="small muted">support@techbrot.com · +1 (877) 751-5575</div>
            </div>
            <div class="text-end">
              <div class="small muted">Receipt</div>
              <div id="pdfOrderId" class="fw-bold">—</div>
              <div id="pdfDate" class="small muted">—</div>
            </div>
          </header>

          <section id="receiptBody">
            <div class="d-flex justify-content-between mb-2">
              <div>
                <div id="pdfCustomerName" class="fw-medium">Customer</div>
                <div id="pdfCustomerEmail" class="small muted"></div>
              </div>
              <div class="small muted text-end">
                <div>Payment method: <span id="pdfPaymentMethod">Card</span></div>
                <div id="pdfSessionId">Session: —</div>
                <div id="acceptedNote" class="small muted mt-1"></div>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-borderless mb-0" id="pdfItems" aria-describedby="pdfItemSummary">
                <thead class="small text-muted border-top">
                  <tr>
                    <th>Item</th>
                    <th class="text-end">Unit</th>
                    <th class="text-end">Qty</th>
                    <th class="text-end">Total</th>
                  </tr>
                </thead>
                <tbody id="pdfItemsBody"><tr><td colspan="4" class="text-center muted py-3">No items found</td></tr></tbody>
                <tfoot class="border-top">
                  <tr><td colspan="3" class="text-end small muted">Subtotal</td><td class="text-end small" id="pdfSubtotal">$0.00</td></tr>
                  <tr><td colspan="3" class="text-end small muted">Tax</td><td class="text-end small" id="pdfTax">$0.00</td></tr>
                  <tr><td colspan="3" class="text-end fw-semibold">Total</td><td class="text-end fw-semibold" id="pdfTotal">$0.00</td></tr>
                </tfoot>
              </table>
            </div>

            <div class="small muted mt-3">Order notes: <span id="pdfNotes">—</span></div>
          </section>
        </article>

        <div class="d-flex gap-2 flex-wrap">
          <button id="downloadReceiptBtn" type="button" class="btn btn-primary btn-lg">Download PDF</button>
          <button id="viewPrintBtn" type="button" class="btn btn-outline-secondary">View / Print</button>
          <a id="backToPlans" class="btn btn-link text-decoration-none" href="/quickbooks/service-plans/index.html">Back to plans</a>
        </div>

        <div id="officialButtons" class="mt-3" style="display:none">
          <div class="small muted mb-2">Official Stripe documents</div>
          <div class="d-flex gap-2">
            <a id="stripeReceiptBtn" class="btn btn-outline-success" target="_blank" rel="noopener">View Stripe receipt</a>
            <a id="stripeInvoiceBtn" class="btn btn-outline-secondary" target="_blank" rel="noopener">Open invoice</a>
            <a id="stripeInvoicePdfBtn" class="btn btn-outline-primary" target="_blank" rel="noopener">Download invoice (PDF)</a>
          </div>
        </div>
      </section>

      <aside class="col-12 col-lg-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <h6 class="card-title mb-2">Order summary</h6>
            <div id="summaryLines" class="mb-3">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div id="summaryItem" class="fw-semibold">Item</div>
                  <div id="summaryDesc" class="small muted"></div>
                </div>
                <div id="summaryPrice" class="fw-semibold">$0.00</div>
              </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3">
              <div class="small muted">Total</div>
              <div id="summaryTotal" class="fs-5 fw-semibold">$0.00</div>
            </div>

            <div class="d-grid">
              <button id="downloadReceiptBtn2" class="btn btn-success">Download receipt</button>
              <a href="/support/index.html" class="btn btn-outline-secondary mt-2">Contact support</a>
            </div>

            <p class="small muted mt-3 mb-0">You may close this page. A copy of the receipt was sent to your email.</p>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <script>
  (function(){
    'use strict';
    const $ = s => document.querySelector(s);
    const param = k => new URL(location.href).searchParams.get(k) || '';
    const centsToMoney = (cents) => {
      // safe digit-by-digit arithmetic
      const n = Number(cents || 0);
      const dollars = Math.floor(n / 100);
      const rem = Math.abs(n % 100);
      return '$' + dollars.toString() + '.' + (rem < 10 ? '0' + rem : rem.toString());
    };

    // receipt model
    const receipt = {
      orderId: param('order') || param('order_id') || (localStorage.getItem('techbrot_last_order_id') || ('ORD-' + Date.now().toString(36).toUpperCase())),
      sessionId: param('session_id') || param('session') || '',
      customerName: '',
      customerEmail: '',
      items: [],
      subtotal: 0, tax: 0, total: 0,
      paymentMethod: 'Card', notes: '',
      acceptance: null // acceptance metadata fallback
    };

    // fetch stripe session
    async function loadStripeSession(){
      if (!receipt.sessionId) return null;
      try {
        const res = await fetch(`/api/retrieve-checkout-session?session_id=${encodeURIComponent(receipt.sessionId)}`, { credentials: 'same-origin' });
        if (!res.ok) return null;
        const data = await res.json();
        if (!data) return null;

        // Fill model
        receipt.customerEmail = data.customer_details?.email || receipt.customerEmail || '';
        receipt.customerName = data.customer_details?.name || receipt.customerName || '';
        receipt.items = (data.line_items || []).map(li => ({
          label: li.description || (li.product && li.product.name) || 'Item',
          unit_amount: li.unit_amount || 0,
          quantity: li.quantity || 1,
          amount_total: li.amount_total || ((li.unit_amount || 0) * (li.quantity || 1)),
          billing: li.recurring?.interval || ''
        }));
        receipt.subtotal = receipt.items.reduce((s,i)=>s + (i.amount_total||0),0);
        receipt.total = data.amount_total || receipt.subtotal;
        receipt.paymentMethod = data.payment_method_types?.[0] || receipt.paymentMethod;
        receipt.notes = data.raw_session?.metadata?.event ? 'stripe' : receipt.notes;

        // official documents
        receipt._official = {
          receipt_url: data.receipt_url || null,
          invoice_pdf: data.invoice_pdf || null,
          hosted_invoice_url: data.hosted_invoice_url || null,
          raw_metadata: data.raw_session?.metadata || {}
        }

        return data;
      } catch (e) {
        console.warn('Stripe fetch failed', e);
        return null;
      }
    }

    // fallback: get acceptance metadata from localStorage or session metadata
    function fallbackAcceptance(rawMeta){
      try {
        // 1) from raw metadata passed from Stripe (if present)
        if (rawMeta && typeof rawMeta === 'object' && rawMeta.items) {
          try {
            const items = JSON.parse(rawMeta.items);
            if (Array.isArray(items) && items.length) {
              receipt.items = items.map(it => ({
                label: it.label || it.key || 'Item',
                unit_amount: Math.round((it.amount || it.unit_amount || 0) * 100),
                quantity: Number(it.qty || it.quantity || 1),
                amount_total: Math.round((it.amount || it.unit_amount || 0) * 100) * Number(it.qty || it.quantity || 1),
                billing: it.billing || ''
              }));
              receipt.subtotal = receipt.items.reduce((s,i)=>s+(i.amount_total||0),0);
              receipt.total = receipt.subtotal;
              receipt.notes = 'acceptance_meta';
              receipt.acceptance = rawMeta;
              return true;
            }
          } catch (e) { /* ignore parse */ }
        }

        // 2) attempt localStorage last order acceptance record (if you stored it)
        const stored = localStorage.getItem('techbrot_acceptance_record');
        if (stored) {
          const rec = JSON.parse(stored);
          if (rec && Array.isArray(rec.lineItems) && rec.lineItems.length) {
            receipt.items = rec.lineItems.map(it => ({
              label: it.label || it.product || it.name,
              unit_amount: Math.round((it.unit_amount || it.price || 0) * 100),
              quantity: Number(it.quantity || 1),
              amount_total: Math.round((it.unit_amount || it.price || 0) * 100) * Number(it.quantity || 1),
              billing: it.billing || ''
            }));
            receipt.subtotal = receipt.items.reduce((s,i)=>s+(i.amount_total||0),0);
            receipt.total = receipt.subtotal;
            receipt.notes = 'local_acceptance';
            receipt.acceptance = rec;
            return true;
          }
        }
      } catch (e) { /* ignore */ }
      return false;
    }

    // render UI
    function render() {
      const set = (sel, txt) => { const el = document.querySelector(sel); if (el) el.textContent = txt; };

      set('#pdfOrderId', receipt.orderId);
      set('#pdfDate', new Date().toLocaleString());
      set('#pdfCustomerName', receipt.customerName || 'Customer');
      set('#pdfCustomerEmail', receipt.customerEmail || '');
      set('#pdfSessionId', receipt.sessionId ? 'Session: ' + receipt.sessionId : '');
      set('#pdfPaymentMethod', receipt.paymentMethod || 'Card');
      set('#pdfNotes', receipt.notes || '');

      const tbody = document.getElementById('pdfItemsBody');
      if (!tbody) return;
      tbody.innerHTML = '';
      if (!receipt.items || !receipt.items.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center muted py-3">No items found</td></tr>';
      } else {
        receipt.items.forEach(it => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(it.label)}${it.billing ? '<div class="small text-muted">' + escapeHtml(it.billing) + '</div>' : ''}</td>
            <td class="text-end small">${centsToMoney(it.unit_amount)}</td>
            <td class="text-end small">${Number(it.quantity||1)}</td>
            <td class="text-end small">${centsToMoney(it.amount_total)}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      set('#pdfSubtotal', centsToMoney(receipt.subtotal));
      set('#pdfTax', centsToMoney(receipt.tax));
      set('#pdfTotal', centsToMoney(receipt.total));

      set('#summaryItem', receipt.items[0]?.label || 'Item');
      set('#summaryDesc', receipt.items[0]?.billing || '');
      set('#summaryPrice', centsToMoney(receipt.total));
      set('#summaryTotal', centsToMoney(receipt.total));

      // acceptance note
      if (receipt.acceptance && receipt.acceptance.timestamp_utc) {
        $('#acceptedNote').textContent = 'Accepted on ' + new Date(receipt.acceptance.timestamp_utc).toLocaleString();
      }
    }

    function escapeHtml(str){ if (typeof str !== 'string') return String(str||''); return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function centsToMoney(c){ if(!c && c!==0) return '$0.00'; const n = Number(c||0); const dollars = Math.floor(n/100); const rem = Math.abs(n%100); return '$'+dollars+'.'+(rem<10?'0'+rem:rem); }

    // notify backend (non-blocking)
    async function notifyBackend() {
      if (!receipt.sessionId) return;
      try {
        await fetch('/api/payment-complete-update', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ session_id: receipt.sessionId })
        });
      } catch (e) { console.warn('notify backend failed', e) }
    }

    // confetti
    function fireConfetti() {
      try {
        const conf = window.confetti;
        if (!conf) return;
        const duration = 2000, end = Date.now()+duration;
        (function frame(){
          conf({ particleCount: 6, startVelocity: 45, spread: 90, origin:{x: Math.random(), y: Math.random()*0.5} });
          if (Date.now() < end) requestAnimationFrame(frame);
        })();
      } catch(e){}
    }

    // PDF generation
    function downloadPDF(){
      const el = document.getElementById('receipt');
      if(!el) return;
      const opt = { margin:10, filename:(receipt.orderId||'receipt') + '.pdf', image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2,useCORS:true}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} };
      html2pdf().set(opt).from(el).save();
    }

    function openPrintView(){
      const w = window.open('','_blank'); if(!w) return;
      const html = `<html><head><title>Receipt - ${escapeHtml(receipt.orderId)}</title><meta name="viewport" content="width=device-width,initial-scale=1" /><style>body{font-family:system-ui, -apple-system,Segoe UI,Roboto,Arial;padding:20px;color:#111}.muted{color:#6c757d}</style></head><body>${document.getElementById('receipt').outerHTML}</body></html>`;
      w.document.write(html); w.document.close(); w.focus();
    }

    // main init
    (async function init(){
      const stripeData = await loadStripeSession();

      // If stripe didn't return items, try acceptance metadata (from stripe metadata or local)
      if ((!stripeData || !stripeData.line_items || stripeData.line_items.length === 0) && stripeData && stripeData.raw_session && stripeData.raw_session.metadata) {
        fallbackAcceptance(stripeData.raw_session.metadata);
      } else if (!stripeData) {
        // try local acceptance record stored by your acceptance page
        const stored = localStorage.getItem('techbrot_acceptance_record');
        if (stored) {
          try { fallbackAcceptance(JSON.parse(stored)) } catch(e){}
        }
      }

      render();

      // Show official doc buttons if available
      if (receipt._official && (receipt._official.receipt_url || receipt._official.hosted_invoice_url || receipt._official.invoice_pdf)) {
        document.getElementById('officialButtons').style.display = 'block';
        if (receipt._official.receipt_url) { $('#stripeReceiptBtn').href = receipt._official.receipt_url; $('#stripeReceiptBtn').style.display='inline-block'; }
        else $('#stripeReceiptBtn').style.display='none';
        if (receipt._official.hosted_invoice_url) { $('#stripeInvoiceBtn').href = receipt._official.hosted_invoice_url; $('#stripeInvoiceBtn').style.display='inline-block'; }
        else $('#stripeInvoiceBtn').style.display='none';
        if (receipt._official.invoice_pdf) { $('#stripeInvoicePdfBtn').href = receipt._official.invoice_pdf; $('#stripeInvoicePdfBtn').style.display='inline-block'; }
        else $('#stripeInvoicePdfBtn').style.display='none';
      }

      // Notify backend (non-blocking)
      notifyBackend();

      // wire up buttons
      $('#downloadReceiptBtn')?.addEventListener('click', downloadPDF);
      $('#downloadReceiptBtn2')?.addEventListener('click', downloadPDF);
      $('#viewPrintBtn')?.addEventListener('click', openPrintView);

      // confetti on first visible load
      fireConfetti();
    })();

  })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
