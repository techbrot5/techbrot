<!doctype html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Payment Successful | TechBrot Inc.</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root {
      --accent: #0ea5e9;
      --muted: #6c757d;
      --line: rgba(0,0,0,0.08);
    }

    body {
      background:#f4f6f8;
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    /* Apple-like card */
    #receipt {
      background:white;
      border-radius:18px;
      padding:32px;
      box-shadow:0 12px 40px rgba(0,0,0,0.06);
      max-width:720px;
      margin:0 auto;
    }

    /* Apple receipt headers */
    #receipt header {
      border-bottom:1px solid var(--line);
      padding-bottom:12px;
      margin-bottom:18px;
    }

    #receipt .merchant {
      font-size:20px;
      font-weight:600;
    }

    /* Apple table style */
    table.receipt-table {
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
    }

    table.receipt-table thead th {
      font-size:13px;
      font-weight:500;
      color:var(--muted);
      border-bottom:1px solid var(--line);
      padding-bottom:6px;
    }

    table.receipt-table tbody td {
      padding:10px 0;
      border-bottom:1px solid #eee;
      font-size:15px;
    }

    table.receipt-table tfoot td {
      padding:6px 0;
      font-size:15px;
    }

    table.receipt-table tfoot tr.total-row td {
      font-weight:600;
      font-size:18px;
      padding-top:14px;
    }

    /* Summary card */
    .summary-card {
      border-radius:14px;
      background:white;
      box-shadow:0 6px 22px rgba(0,0,0,0.05);
    }

    #confetti-canvas {
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:2000;
    }

    .muted { color:var(--muted) !important; }

    .badge-svg { width:58px; height:58px; border-radius:14px; display:inline-flex; align-items:center; justify-content:center; }
  </style>
</head>
<body>
  <canvas id="confetti-canvas" aria-hidden="true"></canvas>

  <main class="container py-4">
    <div class="row g-4" id="successCard">

      <!-- LEFT COLUMN: Receipt -->
      <section class="col-12 col-lg-8">

        <!-- Heading -->
        <div class="d-flex gap-3 mb-3 align-items-start">
          <div class="badge-svg" aria-hidden="true" style="
            background:linear-gradient(180deg,#e5faff,#f7ffff);
            border:1px solid rgba(0,0,0,0.06);
          ">
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="#28a745" viewBox="0 0 24 24" aria-hidden="true"><path d="M20.285 6.709l-11.49 11.49-5.657-5.657 1.414-1.414 4.243 4.243 10.076-10.076z"></path></svg>
          </div>

          <div>
            <h1 class="h4 mb-1">Payment received — thank you</h1>
            <p class="mb-1 muted">A copy of your receipt has been emailed to you. You may also download the PDF below.</p>

            <div class="small muted">
              Need help? Email
              <a href="mailto:support@techbrot.com" class="link-primary">support@techbrot.com</a>
              · Phone:
              <a href="tel:+18777515575" class="link-primary">+1 (877) 751-5575</a>
            </div>
          </div>
        </div>

        <!-- RECEIPT CARD -->
        <article id="receipt" class="mb-3">

          <header>
            <div class="d-flex justify-content-between">
              <div>
                <div class="merchant">TechBrot Inc.</div>
                <div class="small muted">support@techbrot.com · +1 (877) 751-5575</div>
              </div>

              <div class="text-end">
                <div class="small muted">Receipt ID</div>
                <div id="pdfOrderId" class="fw-semibold">—</div>
                <div id="pdfDate" class="small muted">—</div>
              </div>
            </div>
          </header>

          <!-- CUSTOMER INFO -->
          <section class="mb-3">
            <div class="d-flex justify-content-between">
              <div>
                <div class="fw-medium" id="pdfCustomerName">Customer</div>
                <div id="pdfCustomerEmail" class="small muted"></div>
              </div>

              <div class="text-end small muted">
                <div>Payment method: <span id="pdfPaymentMethod">Card</span></div>
                <div id="pdfSessionId" class="mt-1">Session: —</div>
                <div id="acceptedNote" class="small muted mt-1"></div>
              </div>
            </div>
          </section>

          <!-- TABLE -->
          <div class="table-responsive">
            <table class="receipt-table" id="pdfItems">
              <thead>
                <tr>
                  <th>Item</th>
                  <th class="text-end">Unit</th>
                  <th class="text-end">Qty</th>
                  <th class="text-end">Total</th>
                </tr>
              </thead>

              <tbody id="pdfItemsBody">
                <tr>
                  <td colspan="4" class="text-center py-3 muted">Loading items…</td>
                </tr>
              </tbody>

              <tfoot>
                <tr>
                  <td colspan="3" class="text-end muted">Subtotal</td>
                  <td class="text-end" id="pdfSubtotal">$0.00</td>
                </tr>
                <tr>
                  <td colspan="3" class="text-end muted">Tax</td>
                  <td class="text-end" id="pdfTax">$0.00</td>
                </tr>
                <tr class="total-row">
                  <td colspan="3" class="text-end">Total</td>
                  <td class="text-end" id="pdfTotal">$0.00</td>
                </tr>
              </tfoot>
            </table>
          </div>

          <div class="small muted mt-3">Order notes: <span id="pdfNotes">—</span></div>
        </article>

        <!-- action buttons (left column) -->
        <div class="d-flex gap-2 mb-3">
          <button id="downloadReceiptBtn" type="button" class="btn btn-primary btn-lg">Download PDF</button>
          <button id="viewPrintBtn" type="button" class="btn btn-outline-secondary">View / Print</button>
          <a id="backToPlans" class="btn btn-link text-decoration-none" href="/quickbooks/service-plans/index.html">Back to plans</a>
        </div>

        <!-- OFFICIAL STRIPE LINKS -->
        <div id="officialButtons" class="mt-3" style="display:none;">
          <div class="small muted mb-2">Official Stripe documents</div>
          <div class="d-flex gap-2 flex-wrap">
            <a id="stripeReceiptBtn" class="btn btn-outline-success" target="_blank">View Stripe receipt</a>
            <a id="stripeInvoiceBtn" class="btn btn-outline-secondary" target="_blank">Open invoice</a>
            <a id="stripeInvoicePdfBtn" class="btn btn-outline-primary" target="_blank">Download invoice PDF</a>
          </div>
        </div>

      </section>

      <!-- RIGHT COLUMN: SUMMARY -->
      <aside class="col-12 col-lg-4">
        <div class="summary-card p-3">
          <h6 class="fw-semibold mb-3">Order summary</h6>

          <div id="summaryLines" class="mb-2">
            <div class="d-flex justify-content-between">
              <div>
                <div id="summaryItem" class="fw-semibold">Item</div>
                <div id="summaryDesc" class="small muted"></div>
              </div>
              <div id="summaryPrice" class="fw-semibold">$0.00</div>
            </div>
          </div>

          <div class="d-flex justify-content-between border-top pt-3">
            <div class="muted">Total</div>
            <div id="summaryTotal" class="fw-bold fs-4">$0.00</div>
          </div>

          <div class="d-grid mt-3">
            <button id="downloadReceiptBtn2" class="btn btn-success">Download receipt</button>
            <a href="/support/index.html" class="btn btn-outline-secondary mt-2">Contact support</a>
          </div>

          <p class="small muted mt-3 mb-0">
            You may close this page. A copy of the receipt is in your email.
          </p>
        </div>
      </aside>

    </div>
  </main>
<!-- libs (confetti + html2pdf) -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<script>
(function () {
  "use strict";

  // short helpers
  const $ = (sel) => document.querySelector(sel);

  // single centsToMoney helper (digit-by-digit, interval friendly)
  const centsToMoney = (c, interval = null) => {
    c = Number(c || 0);
    const d = Math.floor(c / 100);
    const r = Math.abs(c % 100);
    const formatted = "$" + d + "." + (r < 10 ? "0" + r : r);

    if (!interval) return formatted;
    return interval === "year" ? formatted + "/yr" : interval === "month" ? formatted + "/mo" : formatted;
  };

  // model
  const params = new URL(location.href).searchParams;
  const receipt = {
    orderId: params.get('order') || params.get('order_id') || (function(){ try { return localStorage.getItem('techbrot_last_order_id') } catch(e){ return null } })() || ('ORD-' + Date.now().toString(36).toUpperCase()),
    sessionId: params.get('session_id') || params.get('session') || '',
    customerName: '',
    customerEmail: '',
    items: [],
    subtotal: 0,
    tax: 0,
    total: 0,
    paymentMethod: '',
    notes: '',
    _official: {}
  };

  // confetti canvas
  const confCanvas = document.getElementById('confetti-canvas');
  function ensureCanvas() {
    if (!confCanvas) return null;
    confCanvas.width = window.innerWidth;
    confCanvas.height = window.innerHeight;
    try {
      return confetti.create(confCanvas, { resize: true, useWorker: true });
    } catch (e) {
      return null;
    }
  }
  let confettiFn = ensureCanvas();
  window.addEventListener('resize', () => { confettiFn = ensureCanvas(); });

  async function loadStripeSession() {
    if (!receipt.sessionId) return null;
    try {
      const url = '/api/retrieve-checkout-session?session_id=' + encodeURIComponent(receipt.sessionId);
      const res = await fetch(url, { credentials: 'same-origin' });
      if (!res.ok) return null;
      return await res.json();
    } catch (e) {
      console.warn('loadStripeSession error', e);
      return null;
    }
  }

  function applyAcceptanceFallback(rawMeta) {
    try {
      if (rawMeta && rawMeta.items) {
        try {
          const arr = JSON.parse(rawMeta.items);
          if (Array.isArray(arr) && arr.length) {
            receipt.items = arr.map(it => {
              let unit = Number(it.amount || it.unit_amount || it.price || 0);
              if (unit && String(unit).includes('.')) {
                unit = Math.round(Number(unit) * 100);
              } else if (unit && Math.abs(unit) < 1000) {
                unit = Math.round(Number(unit) * 100);
              } else {
                unit = Math.round(Number(unit || 0));
              }
              const qty = Number(it.qty || it.quantity || 1);
              return {
                label: it.label || it.key || 'Item',
                unit_amount: unit,
                quantity: qty,
                amount_total: unit * qty,
                billing: it.billing || ''
              };
            });
            receipt.total = receipt.items.reduce((s,i)=>s + (i.amount_total||0), 0);
            receipt.subtotal = receipt.total;
            receipt.notes = 'fallback: stripe metadata';
            receipt.acceptance = rawMeta;
            return true;
          }
        } catch(e){}
      }

      let stored = null;
      try { stored = JSON.parse(localStorage.getItem('techbrot_acceptance_record')); } catch(e){}
      if (stored && Array.isArray(stored.lineItems) && stored.lineItems.length) {
        receipt.items = stored.lineItems.map(it => {
          let unit = Number(it.unit_amount || it.price || it.amount || 0);
          if (unit && String(unit).includes('.')) unit = Math.round(Number(unit) * 100);
          else if (unit && Math.abs(unit) < 1000) unit = Math.round(Number(unit) * 100);
          else unit = Math.round(Number(unit || 0));
          const qty = Number(it.quantity || it.qty || 1);
          return {
            label: it.label || it.product || it.name || 'Item',
            unit_amount: unit,
            quantity: qty,
            amount_total: unit * qty,
            billing: it.billing || ''
          };
        });
        receipt.total = receipt.items.reduce((s,i)=>s+(i.amount_total||0),0);
        receipt.subtotal = receipt.total;
        receipt.notes = 'fallback: local acceptance record';
        receipt.acceptance = stored;
        return true;
      }
    } catch (e) {
      console.warn('applyAcceptanceFallback error', e);
    }
    return false;
  }

  function renderReceipt() {
    $('#pdfOrderId').textContent = receipt.orderId;
    $('#pdfDate').textContent = new Date().toLocaleString();
    $('#pdfCustomerName').textContent = receipt.customerName || 'Customer';
    $('#pdfCustomerEmail').textContent = receipt.customerEmail || '';
    $('#pdfPaymentMethod').textContent = receipt.paymentMethod || 'Card';
    $('#pdfSessionId').textContent = receipt.sessionId ? 'Session: ' + receipt.sessionId : '';

    const tbody = document.getElementById('pdfItemsBody');
    tbody.innerHTML = '';
    if (!receipt.items.length) {
      tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3 muted">No items found</td></tr>';
    } else {
      receipt.items.forEach(it => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(it.label)}${it.billing ? ` <span class="text-muted small">(${escapeHtml(it.billing)})</span>` : ""}</td>
          <td class="text-end">${centsToMoney(it.unit_amount, it.billing)}</td>
          <td class="text-end">${Number(it.quantity)}</td>
          <td class="text-end">${centsToMoney(it.amount_total, it.billing)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    $('#pdfSubtotal').textContent = centsToMoney(receipt.subtotal || 0);
    $('#pdfTax').textContent = centsToMoney(receipt.tax || 0);

    /** total should be raw money amount (no /mo or /yr suffix) */
    $('#pdfTotal').textContent = centsToMoney(receipt.total || 0);

    $('#summaryItem').textContent = receipt.items[0]?.label || 'Item';
    $('#summaryDesc').textContent = receipt.items[0]?.billing ? `Billing: ${receipt.items[0].billing}` : '';
    $('#summaryPrice').textContent = centsToMoney(receipt.items[0]?.amount_total || receipt.total || 0, receipt.items[0]?.billing || null);
    $('#summaryTotal').textContent = centsToMoney(receipt.total || 0);

    if (receipt.acceptance && receipt.acceptance.timestamp_utc) {
      const d = new Date(receipt.acceptance.timestamp_utc);
      $('#pdfNotes').textContent = receipt.notes || '';
      $('#acceptedNote').textContent = 'Accepted on ' + d.toLocaleString();
    } else {
      $('#acceptedNote').textContent = '';
      $('#pdfNotes').textContent = receipt.notes || '';
    }

    if (receipt._official) {
      if (receipt._official.receipt_url) {
        $('#stripeReceiptBtn').href = receipt._official.receipt_url;
        $('#stripeReceiptBtn').style.display = 'inline-block';
      } else $('#stripeReceiptBtn').style.display = 'none';

      if (receipt._official.hosted_invoice_url) {
        $('#stripeInvoiceBtn').href = receipt._official.hosted_invoice_url;
        $('#stripeInvoiceBtn').style.display = 'inline-block';
      } else $('#stripeInvoiceBtn').style.display = 'none';

      if (receipt._official.invoice_pdf) {
        $('#stripeInvoicePdfBtn').href = receipt._official.invoice_pdf;
        $('#stripeInvoicePdfBtn').style.display = 'inline-block';
      } else $('#stripeInvoicePdfBtn').style.display = 'none';

      if (receipt._official.receipt_url || receipt._official.hosted_invoice_url || receipt._official.invoice_pdf) {
        $('#officialButtons').style.display = 'block';
      } else $('#officialButtons').style.display = 'none';
    }
  }

  function escapeHtml(s) {
    if (s == null) return '';
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function runConfetti() {
    if (!confettiFn) confettiFn = ensureCanvas();
    if (!confettiFn) return;
    const duration = 1500;
    const end = Date.now() + duration;
    (function frame() {
      confettiFn({ particleCount: 6, spread: 70, startVelocity: 40, origin: { x: Math.random(), y: 0.2 } });
      if (Date.now() < end) requestAnimationFrame(frame);
    })();
  }

  function downloadPDF() {
    const el = document.getElementById('receipt');
    if (!el) return;
    const opt = {
      margin: [10,10,10,10],
      filename: (receipt.orderId || 'receipt') + '.pdf',
      image: { type: 'jpeg', quality: 0.95 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(el).save();
  }

  function openPrintView() {
    const w = window.open('', '_blank');
    if (!w) return;
    const style = `
      <style>
        body{font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial; padding:18px; color:#111}
        .muted{color:#6c757d}
        table{width:100%;border-collapse:collapse}
      </style>
    `;
    w.document.write('<!doctype html><html><head><meta charset="utf-8"><title>Receipt</title>' + style + '</head><body>');
    w.document.write(document.getElementById('receipt').outerHTML);
    w.document.write('</body></html>');
    w.document.close();
    w.focus();
  }

  (async function init() {
    document.getElementById('pdfItemsBody').innerHTML =
      '<tr><td colspan="4" class="text-center py-3 muted">Loading items…</td></tr>';

    const stripeData = await loadStripeSession();
    if (stripeData) {
      try {
        if (stripeData.customer_details) {
          receipt.customerEmail = stripeData.customer_details.email || '';
          receipt.customerName = stripeData.customer_details.name || '';
        }

        if (Array.isArray(stripeData.line_items) && stripeData.line_items.length) {
          // Normalize items robustly: prefer amount_total from Stripe and fix unit_amount scale if mismatch detected
          receipt.items = stripeData.line_items.map(li => {
            // authoritative values from worker
            let unit = Number(li.unit_amount || (li.price && li.price.unit_amount) || 0); // may be cents or dollars (bad upstream)
            const qty = Number(li.quantity || 1) || 1;
            let amount_total = Number(li.amount_total || li.amount_subtotal || 0);

            // If amount_total is zero but stripeData.amount_total exists, try to compute proportionally.
            if (!amount_total && stripeData.amount_total) {
              // fallback: try pro-rating by unit (best-effort)
              amount_total = Math.round((Number(li.unit_amount || 0) * qty) || 0);
            }

            // If mismatch between unit*qty and amount_total, attempt to fix scale:
            // If ratio >= 10, it's likely unit is in dollars and needs *100.
            const computed = (unit || 0) * (qty || 1);
            if (computed !== amount_total) {
              // avoid division by zero
              const ratio = computed ? (amount_total / computed) : 0;
              if (ratio >= 10 && ratio < 10000) {
                // unit is likely in dollars -> convert to cents
                unit = Math.round(unit * 100);
              } else if (unit > 0 && unit < 100 && amount_total >= 1000) {
                // unit small (e.g. 23) but amount_total large => assume dollars->cents
                unit = Math.round(unit * 100);
              } else if (amount_total && qty) {
                // last-resort: recompute unit from amount_total
                unit = Math.round(amount_total / qty);
              }
            }

            // ensure integers
            unit = Math.round(Number(unit || 0));
            amount_total = Math.round(Number(amount_total || unit * qty));

            const interval = li.recurring?.interval || li.price?.recurring?.interval || '';

            return {
              label: li.description || (li.product && li.product.name) || 'Item',
              unit_amount: unit,
              quantity: qty,
              amount_total: amount_total,
              billing: interval
            };
          });

          receipt.subtotal = receipt.items.reduce((s,i)=>s + (i.amount_total||0),0);
          receipt.total = Number(stripeData.amount_total || receipt.subtotal);
          receipt.paymentMethod = stripeData.payment_method_types?.[0] || '';
        }

        receipt._official = {
          receipt_url: stripeData.receipt_url || null,
          invoice_pdf: stripeData.invoice_pdf || null,
          hosted_invoice_url: stripeData.hosted_invoice_url || null,
          raw_metadata: stripeData.raw_session?.metadata || {}
        };
      } catch (e) {
        console.warn('stripeData parse error', e);
      }
    }

    if (!receipt.items.length) {
      const rawMeta = receipt._official.raw_metadata || {};
      applyAcceptanceFallback(rawMeta);
    }

    if (!receipt.items.length) {
      receipt.items = [{
        label: 'Service plan',
        unit_amount: 0,
        quantity: 1,
        amount_total: 0,
        billing: ''
      }];
      receipt.subtotal = 0;
      receipt.total = 0;
      receipt.notes = 'no item data';
    }

    renderReceipt();

    document.getElementById('downloadReceiptBtn')?.addEventListener('click', downloadPDF);
    document.getElementById('downloadReceiptBtn2')?.addEventListener('click', downloadPDF);
    document.getElementById('viewPrintBtn')?.addEventListener('click', openPrintView);

    runConfetti();
  })();

})();
</script>


</body>
</html>
