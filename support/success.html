<!doctype html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Payment Successful â€” TechBrot</title>

  <!-- Lightweight modern styling -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f9fb; --card:#ffffff; --muted:#6b7280; --accent:#0ea5a4; --accent-2:#06b6d4; --success:#16a34a;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:var(--bg);-webkit-font-smoothing:antialiased;}
    .page-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:32px;}
    .card-main{width:100%;max-width:1100px;background:var(--card);border-radius:14px;padding:22px;box-shadow:0 12px 40px rgba(8,20,40,0.06);opacity:0;transform:translateY(8px);transition:all .48s ease}
    .card-main.visible{opacity:1;transform:none}
    .order-badge{width:84px;height:84px;border-radius:12px;background:linear-gradient(180deg,#e6fffa,#ecfeff);display:flex;align-items:center;justify-content:center;font-size:30px;color:var(--accent-2)}
    .summary-card{border-radius:12px;border:1px solid rgba(15,23,42,0.04);background:#fff;padding:16px}
    #receiptForPdf{background:#fff;border-radius:8px;padding:14px;border:1px solid #eef2f7}
    #receiptForPdf table{width:100%;border-collapse:collapse}
    #receiptForPdf th,#receiptForPdf td{padding:8px 6px;border-bottom:1px solid #f1f5f9;font-size:13px}
    .muted{color:var(--muted)}
    .total-amount{font-weight:700;color:var(--success)}
    .btn-primary{background:linear-gradient(90deg,var(--accent-2),var(--accent));border:0}
    #confetti{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:1050}
    @media (min-width:992px){ .layout-grid{display:grid;grid-template-columns:1fr 360px;gap:20px} }
    @media (max-width:991px){ .layout-grid{display:block} }
    .no-select{user-select:none}
    small.text-muted a{color:inherit;text-decoration:underline}
  </style>
</head>
<body>
  <canvas id="confetti" aria-hidden="true"></canvas>

  <div class="page-wrap">
    <main class="card-main" id="cardMain" role="main" aria-labelledby="thankHeading">
      <div class="layout-grid">
        <!-- LEFT / receipt -->
        <section>
          <div class="d-flex align-items-start gap-3 mb-3">
            <div class="order-badge no-select" id="orderEmoji">ðŸŽ‰</div>
            <div class="flex-grow-1">
              <h1 id="thankHeading" class="h4 mb-1">Thanks â€” your order is confirmed</h1>
              <p id="subLead" class="muted mb-0">We've received your payment. A receipt has been emailed (if available).</p>
              <small class="muted d-block mt-2" id="timeNote">Generating receiptâ€¦</small>
            </div>
          </div>

          <div id="receiptForPdf" aria-labelledby="receiptHeading">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="h6 mb-0" id="merchantName">TechBrot â€” QuickBooks Support</div>
                <div class="muted" id="merchantContact">support@techbrot.com Â· +1 (877) 751-5575</div>
              </div>
              <div class="text-end">
                <div class="muted small">Receipt</div>
                <div id="pdfOrderId" style="font-weight:700;font-size:16px">â€”</div>
                <div id="pdfDate" class="muted" style="margin-top:6px">â€”</div>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-12 col-lg-6">
                <strong id="pdfCustomerName">Customer</strong>
                <div class="muted" id="pdfCustomerEmail"></div>
              </div>
              <div class="col-12 col-lg-6 text-lg-end mt-2 mt-lg-0 muted">
                Payment method: <span id="pdfPaymentMethod">Card</span><br>
                <span id="pdfSessionId" class="d-block"></span>
              </div>
            </div>

            <div class="table-responsive mt-3">
              <table class="table table-borderless mb-0" aria-describedby="receipt-items">
                <thead>
                  <tr><th>Item</th><th class="text-end">Unit</th><th class="text-end">Qty</th><th class="text-end">Total</th></tr>
                </thead>
                <tbody id="pdfItemsBody">
                  <tr><td colspan="4" class="text-center muted py-3">Loading items from local storageâ€¦</td></tr>
                </tbody>
                <tfoot>
                  <tr><td colspan="3" class="text-end muted">Subtotal</td><td id="pdfSubtotal" class="text-end">$0.00</td></tr>
                  <tr><td colspan="3" class="text-end muted">Tax</td><td id="pdfTax" class="text-end">$0.00</td></tr>
                  <tr><td colspan="3" class="text-end"><strong>Total</strong></td><td id="pdfTotal" class="text-end total-amount">$0.00</td></tr>
                </tfoot>
              </table>
            </div>

            <div class="muted small mt-3">Order notes: <span id="pdfNotes">â€”</span></div>
          </div>

          <div class="d-flex gap-2 mt-3">
            <button id="downloadReceiptBtn" class="btn btn-primary">Download receipt (PDF)</button>
            <button id="openReceiptViewBtn" class="btn btn-outline-secondary">Print / View</button>
            <button id="confirmBackendBtn" class="btn btn-light" title="Tell backend this session completed (optional)">Confirm backend</button>
          </div>

        </section>

        <!-- RIGHT / summary -->
        <aside class="summary-card">
          <h6 class="mb-3">Order summary</h6>
          <div id="summaryLines" aria-live="polite">
            <div class="line-item">
              <div>
                <strong id="summaryItem">Item</strong>
                <div class="muted small" id="summaryDesc"></div>
              </div>
              <div id="summaryPrice" class="muted text-end">$0.00</div>
            </div>
          </div>

          <div class="d-flex justify-content-between align-items-center mt-2">
            <div class="muted">Total</div>
            <div class="total-amount" id="summaryTotal">$0.00</div>
          </div>

          <div class="mt-3">
            <a id="backPlans" href="/quickbooks/service-plans/index.html" class="btn btn-outline-secondary w-100">Back to plans</a>
          </div>

          <div class="muted small mt-3" id="metaNote">You may close this page. If your payment was via card, Stripe will email a receipt.</div>
        </aside>
      </div>
    </main>
  </div>

  <!-- html2pdf for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <script>
  (function(){
    'use strict';

    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));
    const money = n => '$' + Number(n || 0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    const param = name => (new URL(location.href)).searchParams.get(name) || '';
    const safeJSON = (k) => { try { return JSON.parse(localStorage.getItem(k) || 'null'); } catch(e) { return null; } };

    const cardMain = qs('#cardMain');
    const CONFETTI_MS = 3800;

    // Show confetti once and stop
    function runConfetti() {
      const canvas = qs('#confetti');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const DPR = Math.max(1, window.devicePixelRatio || 1);
      function resize(){ canvas.width = innerWidth * DPR; canvas.height = innerHeight * DPR; canvas.style.width = innerWidth + 'px'; canvas.style.height = innerHeight + 'px'; ctx.setTransform(DPR,0,0,DPR,0,0); }
      resize(); window.addEventListener('resize', resize, {passive:true});

      const pieces = [];
      const colors = ['#06b6d4','#0ea5a4','#60a5fa','#f472b6','#f59e0b','#10b981'];
      for(let i=0;i<80;i++){
        pieces.push({
          x: innerWidth/2 + (Math.random()*300-150),
          y: innerHeight/3 + (Math.random()*120-60),
          vx: (Math.random()*8-4),
          vy: (Math.random()*-6),
          s: 6 + Math.random()*12,
          rot: Math.random()*Math.PI*2,
          vr: (Math.random()*0.14-0.07),
          color: colors[Math.floor(Math.random()*colors.length)],
          life: 120 + Math.floor(Math.random()*200)
        });
      }
      let running = true;
      function step(){
        if (!running) { ctx.clearRect(0,0,canvas.width,canvas.height); return; }
        ctx.clearRect(0,0,canvas.width,canvas.height);
        let alive = 0;
        for(const p of pieces){
          if (p.life <= 0) continue;
          p.x += p.vx; p.y += p.vy; p.vy += 0.12; p.rot += p.vr; p.life--;
          ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot);
          ctx.fillStyle = p.color; ctx.fillRect(-p.s/2, -p.s/2, p.s, p.s); ctx.restore();
          if (p.y < innerHeight + 200 && p.life > 0) alive++;
        }
        if (alive) requestAnimationFrame(step);
        else ctx.clearRect(0,0,canvas.width,canvas.height);
      }
      step();
      // auto-stop after CONFETTI_MS
      setTimeout(()=>{ running = false; try{ ctx.clearRect(0,0,canvas.width,canvas.height); }catch(e){} }, CONFETTI_MS);
    }

    // Build receipt from URL params and localStorage
    const fallbackCartKeys = ['service_plans_cart','pricing_cart','techbrot_cart','pricingCart','cart','checkout_cart'];
    function loadCart() {
      for (const k of fallbackCartKeys) {
        const v = safeJSON(k);
        if (Array.isArray(v) && v.length) return { items: v, key: k };
      }
      return { items: [], key: null };
    }

    const urlOrder = param('order') || param('order_id') || param('orderId') || '';
    const urlSession = param('session_id') || param('session') || param('sessionId') || param('checkout_session') || '';

    // Receipt model
    const receipt = {
      orderId: urlOrder || ('ORD-' + Date.now().toString(36).toUpperCase().slice(2,10)),
      sessionId: urlSession || '',
      createdAt: new Date(),
      customerName: decodeURIComponent(param('name') || '') || decodeURIComponent(param('customer') || '') || '',
      customerEmail: decodeURIComponent(param('email') || '') || '',
      paymentMethod: param('pm') || param('payment_method') || 'Card',
      items: [],
      subtotal: 0,
      tax: 0,
      total: 0,
      notes: ''
    };

    // Try populate from localStorage cart(s)
    const cartResult = loadCart();
    if (cartResult.items && cartResult.items.length) {
      const raw = cartResult.items;
      receipt.items = raw.map(it => {
        // support multiple shapes: {price,quantity,product,productName,label,name,billing}
        const price = Number(it.price ?? it.unit_amount ?? it.unit ?? it.amount ?? it.unit_amount_in ?? 0);
        const qty = Number(it.quantity ?? it.qty ?? 1);
        const label = it.productName || it.product || it.label || it.name || it.plan || 'Service';
        const billing = it.billing || it.interval || it.period || '';
        return { label, unit: price, qty, total: price * qty, billing };
      });
      receipt.subtotal = receipt.items.reduce((s,i)=> s + (i.total||0), 0);
      receipt.total = receipt.subtotal;
      receipt.notes = 'Populated from localStorage key: ' + (cartResult.key || 'unknown');
    }

    // If URL amount provided, prefer it (quick receipts)
    const urlAmount = param('amount') || param('total') || param('price') || '';
    if (urlAmount) {
      const numeric = Number(String(urlAmount).replace(/[^0-9.]/g,'')) || 0;
      receipt.items = [{ label: decodeURIComponent(param('item') || 'Purchase'), unit: numeric, qty:1, total: numeric, billing: '' }];
      receipt.subtotal = numeric; receipt.total = numeric;
    }

    // If tax param present
    const taxPercent = Number(param('tax') || 0);
    if (taxPercent > 0) {
      receipt.tax = +(receipt.subtotal * (taxPercent / 100));
      receipt.total = +(receipt.subtotal + receipt.tax);
    } else {
      receipt.tax = 0;
      receipt.total = receipt.total || receipt.subtotal;
    }

    // Render receipt to DOM
    function setText(sel, txt){ const el = qs(sel); if (el) el.textContent = txt; }
    function renderReceipt(){
      setText('#pdfOrderId', receipt.orderId);
      setText('#pdfDate', receipt.createdAt.toLocaleString());
      setText('#pdfCustomerName', receipt.customerName || 'Valued customer');
      setText('#pdfCustomerEmail', receipt.customerEmail || '');
      setText('#pdfPaymentMethod', receipt.paymentMethod || 'Card');
      setText('#pdfSessionId', receipt.sessionId ? ('Session: ' + receipt.sessionId) : '');

      const tbody = qs('#pdfItemsBody');
      if (!tbody) return;
      tbody.innerHTML = '';
      if (!receipt.items || !receipt.items.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center muted py-3">No items found</td></tr>';
      } else {
        receipt.items.forEach(it => {
          const billingLabel = it.billing ? (' Â· ' + it.billing) : '';
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${escapeHtml(it.label)}<div class="muted small">${escapeHtml(String(it.billing || ''))}</div></td>
                          <td class="text-end">${money(it.unit)}</td>
                          <td class="text-end">${Number(it.qty || 1)}</td>
                          <td class="text-end">${money(it.total)}</td>`;
          tbody.appendChild(tr);
        });
      }
      setText('#pdfSubtotal', money(receipt.subtotal));
      setText('#pdfTax', money(receipt.tax));
      setText('#pdfTotal', money(receipt.total));
      setText('#summaryItem', (receipt.items[0] && receipt.items[0].label) || 'Item');
      setText('#summaryDesc', (receipt.items[0] && receipt.items[0].billing) ? receipt.items[0].billing : '');
      setText('#summaryPrice', money(receipt.total));
      setText('#summaryTotal', money(receipt.total));
      setText('#pdfNotes', receipt.notes || '');
      setText('#timeNote', 'Generated: ' + new Date().toLocaleString());
      const emoji = qs('#orderEmoji'); if (emoji) emoji.textContent = (receipt.total > 0 ? 'âœ…' : 'ðŸŽ‰');
    }

    // Escape helper
    function escapeHtml(s){
      if (s == null) return '';
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // Optional: attempt to fetch server-side checkout session details (if you expose an endpoint)
    async function attemptFetchServerSession(sessionId){
      if (!sessionId) return null;
      const endpoint = '/api/retrieve-checkout-session?session_id=' + encodeURIComponent(sessionId);
      try {
        const res = await fetch(endpoint, { method: 'GET', credentials: 'same-origin' });
        if (!res.ok) { console.info('No server session endpoint or fetch failed', endpoint, res.status); return null; }
        const js = await res.json();
        return js;
      } catch (e) { console.info('fetch server session failed', e); return null; }
    }

    // Optional: notify your backend that payment completed and attach session_id + order_id
    async function notifyBackendOfSuccess(sessionId, orderId){
      if (!sessionId || !orderId) return null;
      // Try a few likely endpoints (non-blocking); your backend may implement one of them.
      const candidates = [
        '/api/acceptance-log/confirm',
        '/api/acceptance-log/complete',
        '/api/acceptance-log/update',
        '/api/acceptance-complete',
        '/api/acceptance-log' // fallback (some users used POST here)
      ];
      for (const ep of candidates) {
        try {
          const payload = { stripe_session_id: sessionId, order_id: orderId, source: 'success_page' };
          const res = await fetch(ep, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload), credentials:'same-origin' });
          if (res.ok) {
            try { const j = await res.json(); console.info('Backend confirm OK', ep, j); return { ok:true, endpoint:ep, data:j }; } catch(e){ console.info('Backend confirm OK', ep); return { ok:true, endpoint:ep }; }
          } else {
            // If 404 or 405, try next â€” do not throw.
            console.info('Backend confirm responded', ep, res.status);
            // try next
          }
        } catch (err) {
          console.info('Backend confirm error', ep, err);
        }
      }
      return null;
    }

    // PDF & print handlers
    (function attachButtons(){
      const dl = qs('#downloadReceiptBtn');
      if (dl) dl.addEventListener('click', () => {
        dl.disabled = true;
        dl.textContent = 'Generating PDFâ€¦';
        try {
          const opt = { margin: 10, filename: (receipt.orderId || 'receipt') + '.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: Math.min(2, window.devicePixelRatio || 1), useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
          html2pdf().set(opt).from(qs('#receiptForPdf')).save().then(()=>{ dl.disabled = false; dl.textContent = 'Download receipt (PDF)'; }).catch(err=>{ console.error('PDF failed', err); alert('PDF generation failed'); dl.disabled = false; dl.textContent = 'Download receipt (PDF)'; });
        } catch (e) { console.error('pdf error', e); alert('PDF generation failed'); dl.disabled=false; dl.textContent='Download receipt (PDF)'; }
      });
      const openBtn = qs('#openReceiptViewBtn');
      if (openBtn) openBtn.addEventListener('click', ()=>{
        const w = window.open('', '_blank');
        if (!w) { alert('Popup blocked. Allow popups or print manually.'); return; }
        const html = `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Receipt - ${escapeHtml(receipt.orderId)}</title><style>body{font-family:Inter,system-ui;padding:20px;color:#111}table{width:100%;border-collapse:collapse}th,td{padding:8px;border-bottom:1px solid #eee}</style></head><body>${qs('#receiptForPdf').outerHTML}<script>window.print();</script></body></html>`;
        w.document.open(); w.document.write(html); w.document.close();
      });

      const confirmBtn = qs('#confirmBackendBtn');
      if (confirmBtn) confirmBtn.addEventListener('click', async ()=>{
        confirmBtn.disabled = true; confirmBtn.textContent = 'Notifying backendâ€¦';
        try {
          const r = await notifyBackendOfSuccess(receipt.sessionId, receipt.orderId);
          if (r && r.ok) { confirmBtn.textContent = 'Backend notified'; }
          else { confirmBtn.textContent = 'No backend endpoint found'; setTimeout(()=>confirmBtn.textContent = 'Confirm backend', 2500); }
        } catch (e) { console.error(e); confirmBtn.textContent = 'Confirm backend'; }
        confirmBtn.disabled = false;
      });
    })();

    // Auto actions: confetti, render, try fetch server session, try notify backend
    (async function main(){
      try { runConfetti(); } catch(e) { /* ignore */ }

      // reveal UI after a brief delay (confetti visible)
      setTimeout(()=>{ try { cardMain.classList.add('visible'); } catch(e){} }, 380);

      renderReceipt();

      // If server-side session endpoint exists, try to fetch authoritative info
      if (receipt.sessionId) {
        try {
          const server = await attemptFetchServerSession(receipt.sessionId);
          if (server) {
            // server may return: customer_email, amount_total, line_items, payment_method_details
            if (server.customer_email) receipt.customerEmail = server.customer_email;
            if (server.customer_name) receipt.customerName = server.customer_name;
            if (typeof server.amount_total !== 'undefined') {
              const amt = Number(server.amount_total) / (server.currency && server.currency.toLowerCase() === 'usd' ? 100 : 1);
              receipt.items = [{ label: 'Payment', unit: amt, qty: 1, total: amt }];
              receipt.subtotal = amt; receipt.total = amt;
            }
            if (Array.isArray(server.line_items) && server.line_items.length) {
              receipt.items = server.line_items.map(li => ({ label: li.description || li.name || 'Item', unit: Number(li.amount || li.unit_amount || 0) / 100 || Number(li.unit_amount || li.amount || 0), qty: li.quantity || 1, total: (Number(li.amount || li.unit_amount || 0) / 100) * (li.quantity||1), billing: li.recurring || '' }));
              receipt.subtotal = receipt.items.reduce((s,i)=>s+(i.total||0),0);
              receipt.total = receipt.subtotal;
            }
            if (server.payment_method_details) receipt.paymentMethod = server.payment_method_details.type || receipt.paymentMethod;
            renderReceipt();
          }
        } catch (e) { console.info('server session fetch skipped', e); }
      }

      // Optionally auto-notify backend once (non-blocking)
      if (receipt.sessionId && receipt.orderId) {
        try {
          const res = await notifyBackendOfSuccess(receipt.sessionId, receipt.orderId);
          if (res && res.ok) console.info('auto backend linked to session', res.endpoint);
        } catch (e) { console.info('auto backend notify failed', e); }
      }

      // store last order locally for convenience
      try { localStorage.setItem('techbrot_last_order_id', receipt.orderId); } catch(e){}
    })();

  })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
